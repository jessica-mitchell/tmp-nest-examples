#
# Workflow for running NEST Python examples using artifacts from nest-simulator repo
#
# Reads examples.yml config and runs examples in batches using matrix strategy.
# Collects generated figures and deploys to GitHub Pages.
#
# Prerequisites:
# 1. Create a Personal Access Token (PAT) with 'actions:read' permission
# 2. Add it as a secret named 'GH_PAT' in this repository
#
name: "Run NEST examples"

on:
  workflow_dispatch:
    inputs:
      nest_workflow_run_id:
        description: 'Workflow run ID from nest-simulator (leave empty for latest successful run)'
        required: false
        type: string
      example_filter:
        description: 'Run only examples matching this pattern (e.g., "brunel" or "spatial_"). Leave empty for all.'
        required: false
        type: string
      batch_size:
        description: 'Number of examples per batch (default: 10)'
        required: false
        type: number
        default: 10
  schedule:
    - cron: '0 3 * * *'

env:
  BATCH_SIZE: ${{ github.event.inputs.batch_size || 10 }}

jobs:
  # ---------------------------------------------------------------------------
  # Job 1: Read config and generate batched matrix
  # ---------------------------------------------------------------------------
  prepare:
    runs-on: ubuntu-22.04
    outputs:
      matrix: ${{ steps.generate-matrix.outputs.matrix }}
      run_id: ${{ steps.set-run-id.outputs.run_id }}
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
        with:
          egress-policy: audit
          disable-telemetry: true

      - name: "Checkout repository"
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: "Get latest successful workflow run ID"
        if: ${{ github.event.inputs.nest_workflow_run_id == '' }}
        id: get-run-id
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          github-token: ${{ secrets.GH_PAT }}
          script: |
            // TODO: Update owner/repo/branch for production
            const { data: runs } = await github.rest.actions.listWorkflowRuns({
              owner: 'jessica-mitchell',
              repo: 'nest-simulator',
              workflow_id: 'nestbuildmatrix.yml',
              status: 'success',
              branch: 'test-artifact-ci',
              per_page: 1
            });

            if (runs.workflow_runs.length === 0) {
              throw new Error('No successful workflow runs found');
            }

            core.setOutput('run_id', runs.workflow_runs[0].id);

      - name: "Set run ID output"
        id: set-run-id
        run: |
          if [ -n "${{ github.event.inputs.nest_workflow_run_id }}" ]; then
            echo "run_id=${{ github.event.inputs.nest_workflow_run_id }}" >> $GITHUB_OUTPUT
          else
            echo "run_id=${{ steps.get-run-id.outputs.run_id }}" >> $GITHUB_OUTPUT
          fi

      - name: "Generate batched matrix from config"
        id: generate-matrix
        run: |
          # Install yq for YAML parsing
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/download/v4.35.1/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

          FILTER="${{ github.event.inputs.example_filter }}"
          BATCH_SIZE="${{ env.BATCH_SIZE }}"

          # Extract examples with type=python from config
          if [ -n "$FILTER" ]; then
            EXAMPLES=$(yq -o=json -I=0 '.examples | map(select(.type == "python" and .name | test("'"$FILTER"'")))' pynest/examples/examples.yml)
          else
            EXAMPLES=$(yq -o=json -I=0 '.examples | map(select(.type == "python"))' pynest/examples/examples.yml)
          fi

          # Count examples
          COUNT=$(echo "$EXAMPLES" | yq 'length')
          echo "Found $COUNT examples to run"

          # Calculate number of batches
          NUM_BATCHES=$(( (COUNT + BATCH_SIZE - 1) / BATCH_SIZE ))
          echo "Creating $NUM_BATCHES batches of up to $BATCH_SIZE examples each"

          # Create batched matrix using Python for easier JSON handling
          python3 << EOF
          import json
          import math

          examples = json.loads('''$EXAMPLES''')
          batch_size = int("$BATCH_SIZE")
          num_batches = math.ceil(len(examples) / batch_size)

          batches = []
          for i in range(num_batches):
              start = i * batch_size
              end = min(start + batch_size, len(examples))
              batch_examples = examples[start:end]

              # Create batch entry with just name/path pairs
              batch_data = [{"name": ex["name"], "path": ex["path"]} for ex in batch_examples]

              batches.append({
                  "batch_id": i + 1,
                  "batch_name": f"batch-{i+1:02d}",
                  "examples": json.dumps(batch_data)
              })

          matrix = {"include": batches}
          print(f"matrix={json.dumps(matrix)}")
          EOF

          # Capture Python output
          MATRIX=$(python3 << EOF
          import json
          import math

          examples = json.loads('''$EXAMPLES''')
          batch_size = int("$BATCH_SIZE")
          num_batches = math.ceil(len(examples) / batch_size)

          batches = []
          for i in range(num_batches):
              start = i * batch_size
              end = min(start + batch_size, len(examples))
              batch_examples = examples[start:end]
              batch_data = [{"name": ex["name"], "path": ex["path"]} for ex in batch_examples]

              batches.append({
                  "batch_id": i + 1,
                  "batch_name": f"batch-{i+1:02d}",
                  "examples": json.dumps(batch_data)
              })

          matrix = {"include": batches}
          print(json.dumps(matrix))
          EOF
          )

          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT

  # ---------------------------------------------------------------------------
  # Job 2: Run batches of examples in parallel
  # ---------------------------------------------------------------------------
  run-batch:
    needs: prepare
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      max-parallel: 5
      matrix: ${{ fromJson(needs.prepare.outputs.matrix) }}
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
        with:
          egress-policy: audit
          disable-telemetry: true

      - name: "Checkout repository"
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: "Set up Python 3.x"
        uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c # v6.0.0
        with:
          python-version: "3.10"

      - name: "Download NEST installation artifact"
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5.0.0
        with:
          name: nest-installation
          github-token: ${{ secrets.GH_PAT }}
          # TODO: Update repository for production
          repository: jessica-mitchell/nest-simulator
          run-id: ${{ needs.prepare.outputs.run_id }}

      - name: "Extract NEST installation"
        run: |
          sudo mkdir -p /opt/nest
          sudo tar -xzf nest-installation.tar.gz -C /opt/nest --strip-components=1

      - name: "Set up NEST environment"
        run: |
          echo "/opt/nest/bin" >> $GITHUB_PATH
          echo "PYTHONPATH=/opt/nest/lib/python3.10/site-packages:$PYTHONPATH" >> $GITHUB_ENV

      - name: "Install system dependencies"
        run: |
          sudo apt-get update
          sudo apt-get install -y texlive-latex-base texlive-latex-extra texlive-fonts-recommended dvipng cm-super

      - name: "Install Python dependencies"
        run: |
          python -m pip install --upgrade pip
          pip install numpy scipy matplotlib pandas h5py cycler imageio requests

      - name: "Verify NEST installation"
        run: python -c "import nest; print(f'NEST {nest.__version__} installed successfully')"

      - name: "Run batch: ${{ matrix.batch_name }}"
        id: run-batch
        working-directory: pynest/examples
        run: |
          mkdir -p outputs
          RESULTS_FILE="outputs/results.json"
          echo '[]' > "$RESULTS_FILE"

          # Parse examples JSON
          EXAMPLES='${{ matrix.examples }}'

          # Run each example in the batch
          echo "$EXAMPLES" | python3 -c "
          import json
          import sys
          examples = json.load(sys.stdin)
          for ex in examples:
              print(f\"{ex['name']}|{ex['path']}\")
          " | while IFS='|' read -r name path; do
            echo ""
            echo "========================================"
            echo "Running: $name"
            echo "Path: $path"
            echo "========================================"

            mkdir -p "outputs/$name"

            # Run example with wrapper script
            set +e
            python run_example.py "$path" "outputs/$name" 2>&1 | tee "outputs/$name/run.log"
            EXIT_CODE=${PIPESTATUS[0]}
            set -e

            # Record result
            if [ $EXIT_CODE -eq 0 ]; then
              STATUS="success"
              echo "Result: SUCCESS"
            else
              STATUS="failed"
              echo "::warning::Example $name failed with exit code $EXIT_CODE"
              echo "Result: FAILED (exit code $EXIT_CODE)"
            fi

            # Count output files
            OUTPUT_COUNT=$(find "outputs/$name" -type f \( -name "*.png" -o -name "*.pdf" -o -name "*.svg" \) 2>/dev/null | wc -l)
            echo "Generated $OUTPUT_COUNT figure(s)"

            # Append to results
            python3 << PYEOF
          import json
          with open("$RESULTS_FILE", "r") as f:
              results = json.load(f)
          results.append({
              "name": "$name",
              "status": "$STATUS",
              "exit_code": $EXIT_CODE,
              "outputs": $OUTPUT_COUNT
          })
          with open("$RESULTS_FILE", "w") as f:
              json.dump(results, f, indent=2)
          PYEOF

          done

          # Summary
          echo ""
          echo "========================================"
          echo "Batch Summary"
          echo "========================================"
          cat "$RESULTS_FILE"

      - name: "Upload batch outputs"
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        if: always()
        with:
          name: ${{ matrix.batch_name }}
          path: pynest/examples/outputs/
          retention-days: 30
          if-no-files-found: ignore

  # ---------------------------------------------------------------------------
  # Job 3: Collect all outputs and deploy to GitHub Pages
  # ---------------------------------------------------------------------------
  collect-and-deploy:
    needs: run-batch
    if: always()
    runs-on: ubuntu-22.04
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
        with:
          egress-policy: audit
          disable-telemetry: true

      - name: "Download all batch artifacts"
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5.0.0
        with:
          pattern: batch-*
          path: all-outputs
          merge-multiple: false

      - name: "Organize outputs for deployment"
        run: |
          mkdir -p deploy/examples

          # Collect results from all batches
          echo '[]' > all-results.json

          # Move each example's outputs and collect results
          for batch_dir in all-outputs/batch-*/; do
            if [ -d "$batch_dir" ]; then
              echo "Processing $batch_dir"

              # Merge results
              if [ -f "${batch_dir}results.json" ]; then
                python3 << PYEOF
          import json
          with open("all-results.json", "r") as f:
              all_results = json.load(f)
          with open("${batch_dir}results.json", "r") as f:
              batch_results = json.load(f)
          all_results.extend(batch_results)
          with open("all-results.json", "w") as f:
              json.dump(all_results, f, indent=2)
          PYEOF
              fi

              # Copy example outputs
              for example_dir in "${batch_dir}"*/; do
                if [ -d "$example_dir" ] && [ "$(basename "$example_dir")" != "results.json" ]; then
                  example_name=$(basename "$example_dir")
                  mkdir -p "deploy/examples/$example_name"
                  cp -r "$example_dir"* "deploy/examples/$example_name/" 2>/dev/null || true
                fi
              done
            fi
          done

          # Generate summary
          echo ""
          echo "========================================"
          echo "Overall Results"
          echo "========================================"
          python3 << 'PYEOF'
          import json
          with open("all-results.json", "r") as f:
              results = json.load(f)

          total = len(results)
          success = sum(1 for r in results if r["status"] == "success")
          failed = sum(1 for r in results if r["status"] == "failed")
          outputs = sum(r["outputs"] for r in results)

          print(f"Total examples: {total}")
          print(f"Successful: {success}")
          print(f"Failed: {failed}")
          print(f"Total figures generated: {outputs}")

          if failed > 0:
              print("\nFailed examples:")
              for r in results:
                  if r["status"] == "failed":
                      print(f"  - {r['name']} (exit code {r['exit_code']})")
          PYEOF

          # Copy results to deploy
          cp all-results.json deploy/examples/

          # Generate index page
          python3 << 'PYEOF'
          import json
          import os
          from datetime import datetime

          with open("all-results.json", "r") as f:
              results = json.load(f)

          # Sort by name
          results.sort(key=lambda x: x["name"])

          total = len(results)
          success = sum(1 for r in results if r["status"] == "success")
          failed = total - success

          html = f'''<!DOCTYPE html>
          <html>
          <head>
            <title>NEST Example Outputs</title>
            <style>
              body {{ font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 1400px; margin: 0 auto; padding: 20px; }}
              h1 {{ color: #333; }}
              .summary {{ background: #f5f5f5; padding: 15px; border-radius: 8px; margin-bottom: 20px; }}
              .summary .success {{ color: #22863a; }}
              .summary .failed {{ color: #cb2431; }}
              .example-grid {{ display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }}
              .example-card {{ border: 1px solid #ddd; padding: 15px; border-radius: 8px; }}
              .example-card.success {{ border-left: 4px solid #22863a; }}
              .example-card.failed {{ border-left: 4px solid #cb2431; background: #ffeef0; }}
              .example-card h3 {{ margin: 0 0 10px 0; font-size: 14px; }}
              .example-card .status {{ font-size: 12px; color: #666; }}
              .example-card ul {{ margin: 10px 0 0 0; padding-left: 20px; font-size: 13px; }}
              .example-card img {{ max-width: 100%; height: auto; margin-top: 10px; }}
            </style>
          </head>
          <body>
            <h1>NEST Example Outputs</h1>
            <div class="summary">
              <strong>Generated:</strong> {datetime.utcnow().strftime("%Y-%m-%d %H:%M UTC")}<br>
              <strong>Total:</strong> {total} examples |
              <span class="success">Successful: {success}</span> |
              <span class="failed">Failed: {failed}</span>
            </div>
            <div class="example-grid">
          '''

          for result in results:
              name = result["name"]
              status = result["status"]
              outputs = result["outputs"]

              example_dir = f"deploy/examples/{name}"
              files = []
              if os.path.isdir(example_dir):
                  files = [f for f in os.listdir(example_dir) if f.endswith(('.png', '.pdf', '.svg', '.log'))]

              html += f'''
              <div class="example-card {status}">
                <h3>{name}</h3>
                <div class="status">Status: {status.upper()} | Outputs: {outputs}</div>
              '''

              if files:
                  html += '<ul>'
                  for f in sorted(files):
                      html += f'<li><a href="{name}/{f}">{f}</a></li>'
                  html += '</ul>'

              html += '</div>'

          html += '''
            </div>
          </body>
          </html>
          '''

          with open("deploy/examples/index.html", "w") as f:
              f.write(html)
          PYEOF

          echo "Deployment structure:"
          find deploy -type f | head -50

      - name: "Deploy to GitHub Pages"
        if: github.event_name == 'workflow_dispatch'
        uses: peaceiris/actions-gh-pages@373f7f263a76c20808c831209c920827a82a2847 # v3.9.3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: deploy
          destination_dir: .
          keep_files: true
